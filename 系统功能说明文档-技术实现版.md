# å¤šæ™ºèƒ½ä½“RAGå®¢æœç³»ç»ŸåŠŸèƒ½è¯´æ˜æ–‡æ¡£ - æŠ€æœ¯å®ç°ç‰ˆ

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäºå¤šæ™ºèƒ½ä½“ï¼ˆMulti-Agentï¼‰å’Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generation, RAGï¼‰æŠ€æœ¯çš„å®¢æˆ·æ”¯æŒç³»ç»Ÿã€‚å®ƒåˆ©ç”¨ Pythonã€LangChain å’Œ LangGraph æ„å»ºäº†ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†å„ç§æ—…è¡Œç›¸å…³æŸ¥è¯¢çš„å¯¹è¯å¼ AIï¼ŒåŒ…æ‹¬èˆªç­é¢„è®¢ã€ç§Ÿè½¦ã€é…’åº—é¢„è®¢å’Œè¡Œç¨‹æ¨èã€‚

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œä¸»è¦ç”±ä¸€ä¸ªä¸»åŠ©æ‰‹ï¼ˆPrimary Assistantï¼‰å’Œå¤šä¸ªä¸“é—¨å¤„ç†ç‰¹å®šä»»åŠ¡çš„å­åŠ©æ‰‹ï¼ˆSpecialized Assistantsï¼‰ç»„æˆã€‚è¿™ç§è®¾è®¡ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·éœ€æ±‚çµæ´»åœ°åœ¨ä¸åŒåŠ©æ‰‹é—´åˆ‡æ¢ï¼ŒåŒæ—¶é€šè¿‡æ•æ„Ÿæ“ä½œç¡®è®¤æœºåˆ¶å’Œæ–°å¢çš„å®‰å…¨æŠ¤æ æœºåˆ¶ä¿éšœç”¨æˆ·æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šè¿è¡Œã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 2.1 ä¸»åŠ©æ‰‹ (Primary Assistant)
- **åŠŸèƒ½**ï¼šä½œä¸ºç”¨æˆ·äº¤äº’çš„å…¥å£ç‚¹ï¼Œå¤„ç†é€šç”¨æŸ¥è¯¢ï¼Œå¹¶æ ¹æ®ç”¨æˆ·éœ€æ±‚å°†ä»»åŠ¡å§”æ´¾ç»™ç›¸åº”çš„ä¸“é—¨åŠ©æ‰‹ã€‚
- **å·¥å…·**ï¼š
  - `DuckDuckGoSearchResults`ï¼šç”¨äºç½‘ç»œæœç´¢ã€‚
  - `search_flights`ï¼šæœç´¢èˆªç­ä¿¡æ¯ã€‚
  - `lookup_policy`ï¼šæŸ¥è¯¢å…¬å¸æ”¿ç­–ã€‚
  - å§”æ´¾å·¥å…·ï¼ˆå°†ä»»åŠ¡è½¬äº¤ç»™ä¸“é—¨åŠ©æ‰‹ï¼‰ï¼š
    - `ToFlightBookingAssistant`ï¼šå¤„ç†èˆªç­æ›´æ–°å’Œå–æ¶ˆã€‚
    - `ToBookCarRental`ï¼šå¤„ç†ç§Ÿè½¦é¢„è®¢ã€‚
    - `ToHotelBookingAssistant`ï¼šå¤„ç†é…’åº—é¢„è®¢ã€ä¿®æ”¹å’Œå–æ¶ˆã€‚
    - `ToBookExcursion`ï¼šå¤„ç†è¡Œç¨‹æ¨èå’Œå…¶ä»–æ´»åŠ¨é¢„è®¢ã€‚
    - `ToWooCommerceProducts`ï¼šå¤„ç† WooCommerce äº§å“æœç´¢ã€‚
    - `ToWooCommerceOrders`ï¼šå¤„ç† WooCommerce è®¢å•æœç´¢ï¼ˆéœ€è¦ç”¨æˆ·æä¾›é‚®ç®±æˆ–å§“åéªŒè¯ï¼‰ã€‚
    - `ToFormSubmission`ï¼šå¤„ç†ç”¨æˆ·è¡¨å•æäº¤ã€‚
    - `ToBlogSearch`ï¼šå¤„ç†åšå®¢æ–‡ç« æœç´¢ã€‚

**ä»£ç å®ç°è¯´æ˜ï¼š**
ä¸»åŠ©æ‰‹åœ¨ <mcfile name="primary_assistant.py" path="customer_support_chat/app/services/assistants/primary_assistant.py"></mcfile> ä¸­å®šä¹‰ï¼Œä½¿ç”¨ LangChain çš„ ChatPromptTemplate åˆ›å»ºç³»ç»Ÿæç¤ºï¼Œå¹¶é€šè¿‡ llm.bind_tools() ç»‘å®šæ‰€æœ‰å·¥å…·ã€‚å§”æ´¾å·¥å…·ä½¿ç”¨ Pydantic BaseModel å®šä¹‰ï¼ŒåŒ…å«å¿…è¦çš„å­—æ®µæè¿°ã€‚

**å§”æ´¾å®ç°åŸç†ï¼š**

å§”æ´¾æœºåˆ¶æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒè®¾è®¡ï¼Œé€šè¿‡Pydanticæ¨¡å‹å®šä¹‰å§”æ´¾å·¥å…·ï¼Œç»“åˆLangGraphçš„çŠ¶æ€è·¯ç”±å®ç°æ™ºèƒ½ä»»åŠ¡åˆ†å‘ã€‚å…·ä½“åŸç†å¦‚ä¸‹ï¼š

### 1. å§”æ´¾å·¥å…·å®šä¹‰
å§”æ´¾å·¥å…·ä½¿ç”¨Pydantic BaseModelå®šä¹‰ï¼Œæ¯ä¸ªå§”æ´¾å·¥å…·å¯¹åº”ä¸€ä¸ªä¸“é—¨åŠ©æ‰‹ï¼š

```python
class ToFlightBookingAssistant(BaseModel):
    """Transfers work to a specialized assistant to handle flight updates and cancellations."""
    request: str = Field(description="Any necessary follow-up questions the update flight assistant should clarify before proceeding.")
```

### 2. å·¥å…·ç»‘å®šä¸è·¯ç”±
ä¸»åŠ©æ‰‹é€šè¿‡`llm.bind_tools()`ç»‘å®šæ‰€æœ‰å§”æ´¾å·¥å…·ï¼Œå½“ç”¨æˆ·è¯·æ±‚éœ€è¦ä¸“é—¨å¤„ç†æ—¶ï¼Œä¸»åŠ©æ‰‹ä¼šè°ƒç”¨ç›¸åº”çš„å§”æ´¾å·¥å…·ï¼š

```python
primary_assistant_tools = [
    DuckDuckGoSearchResults(max_results=10),
    search_flights,
    lookup_policy,
    ToFlightBookingAssistant,  # èˆªç­é¢„è®¢å§”æ´¾
    ToBookCarRental,          # ç§Ÿè½¦å§”æ´¾
    ToHotelBookingAssistant,   # é…’åº—å§”æ´¾
    ToBookExcursion,          # æ—…è¡Œæ¨èå§”æ´¾
    ToWooCommerceProducts,     # äº§å“æœç´¢å§”æ´¾
    ToWooCommerceOrders,       # è®¢å•æœç´¢å§”æ´¾
    ToFormSubmission,         # è¡¨å•æäº¤å§”æ´¾
    ToBlogSearch,             # åšå®¢æœç´¢å§”æ´¾
]
```

### 3. è·¯ç”±æœºåˆ¶
å½“ä¸»åŠ©æ‰‹è°ƒç”¨å§”æ´¾å·¥å…·åï¼Œ`route_primary_assistant`å‡½æ•°æ ¹æ®å·¥å…·åç§°è·¯ç”±åˆ°å¯¹åº”çš„ä¸“é—¨åŠ©æ‰‹ï¼š

```python
def route_primary_assistant(state: State):
    route = tools_condition(state)
    if route == END:
        return END
    tool_calls = state["messages"][-1].tool_calls
    if tool_calls:
        tool_name = tool_calls[0]["name"]
        if tool_name == ToFlightBookingAssistant.__name__:
            return "enter_update_flight"  # è·¯ç”±åˆ°èˆªç­åŠ©æ‰‹
        elif tool_name == ToBookCarRental.__name__:
            return "enter_book_car_rental"  # è·¯ç”±åˆ°ç§Ÿè½¦åŠ©æ‰‹
        # ... å…¶ä»–å§”æ´¾å·¥å…·è·¯ç”±
    return "primary_assistant"
```

### 4. å…¥å£èŠ‚ç‚¹åˆ›å»º
æ¯ä¸ªä¸“é—¨åŠ©æ‰‹éƒ½æœ‰ä¸€ä¸ªå…¥å£èŠ‚ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ–åŠ©æ‰‹çŠ¶æ€å’Œä¸Šä¸‹æ–‡ï¼š

```python
def create_entry_node(assistant_name: str, new_dialog_state: str) -> Callable:
    def entry_node(state: State) -> dict:
        # å¤„ç†å·¥å…·è°ƒç”¨æ¶ˆæ¯
        last_message = state["messages"][-1]
        tool_messages = []
        
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            for tool_call in last_message.tool_calls:
                tool_messages.append(
                    ToolMessage(
                        content=(
                            f"The assistant is now the {assistant_name}. Reflect on the above conversation. "
                            f"The user's intent is unsatisfied. Use the provided tools to assist the user. "
                            "If the user changes their mind, call CompleteOrEscalate to return to primary assistant."
                        ),
                        tool_call_id=tool_call["id"],
                    )
                )
        return {"messages": tool_messages, "dialog_state": new_dialog_state}
    return entry_node
```

### 5. çŠ¶æ€ç®¡ç†
ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„Stateç±»ç®¡ç†å¯¹è¯çŠ¶æ€ï¼ŒåŒ…å«æ¶ˆæ¯ã€ç”¨æˆ·ä¿¡æ¯å’Œå¯¹è¯çŠ¶æ€æ ˆï¼š

```python
class State(TypedDict):
    messages: Annotated[list[Any], operator.add]
    user_info: str
    dialog_state: Annotated[Optional[list[str]], update_dialog_stack]
```

### 6. å·¥å…·æ¡ä»¶åˆ¤æ–­
LangGraphå†…ç½®çš„`tools_condition`å‡½æ•°è‡ªåŠ¨æ£€æµ‹å·¥å…·è°ƒç”¨çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥è·¯ç”±ï¼š
- å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œè·¯ç”±åˆ°å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
- å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè·¯ç”±åˆ°ä¸‹ä¸€ä¸ªåŠ©æ‰‹èŠ‚ç‚¹
- å¦‚æœå¯¹è¯ç»“æŸï¼Œè¿”å›ENDçŠ¶æ€

### 7. å§”æ´¾æµç¨‹æ€»ç»“
1. **ç”¨æˆ·è¯·æ±‚** â†’ ä¸»åŠ©æ‰‹å¤„ç†
2. **è¯†åˆ«éœ€æ±‚** â†’ ä¸»åŠ©æ‰‹åˆ¤æ–­éœ€è¦ä¸“é—¨å¤„ç†
3. **è°ƒç”¨å§”æ´¾å·¥å…·** â†’ ç”Ÿæˆå§”æ´¾å·¥å…·è°ƒç”¨
4. **è·¯ç”±æ£€æµ‹** â†’ `tools_condition`æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨
5. **ä¸“é—¨åŠ©æ‰‹è·¯ç”±** â†’ `route_primary_assistant`æ ¹æ®å·¥å…·åç§°è·¯ç”±
6. **å…¥å£èŠ‚ç‚¹åˆå§‹åŒ–** â†’ åˆ›å»ºä¸“é—¨åŠ©æ‰‹ä¸Šä¸‹æ–‡
7. **ä¸“é—¨å¤„ç†** â†’ ä¸“é—¨åŠ©æ‰‹ä½¿ç”¨ä¸“ç”¨å·¥å…·å®Œæˆä»»åŠ¡
8. **è¿”å›ä¸»åŠ©æ‰‹** â†’ é€šè¿‡CompleteOrEscalateå·¥å…·æˆ–ä»»åŠ¡å®Œæˆè¿”å›


### 2.2 èˆªç­é¢„è®¢åŠ©æ‰‹ (Flight Booking Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†èˆªç­æ›´æ–°å’Œå–æ¶ˆè¯·æ±‚ã€‚
- **å·¥å…·**ï¼š
  - **å®‰å…¨å·¥å…·**ï¼š
    - `search_flights`ï¼šæœç´¢èˆªç­ã€‚
    - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚
  - **æ•æ„Ÿå·¥å…·**ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
    - `update_ticket_to_new_flight`ï¼šæ›´æ–°æœºç¥¨åˆ°æ–°èˆªç­ã€‚
    - `cancel_ticket`ï¼šå–æ¶ˆæœºç¥¨ã€‚

**ä»£ç å®ç°è¯´æ˜ï¼š**
èˆªç­åŠ©æ‰‹åœ¨ <mcfile name="flight_booking_assistant.py" path="customer_support_chat/app/services/assistants/flight_booking_assistant.py"></mcfile> ä¸­å®ç°ï¼Œä½¿ç”¨ä¸“é—¨çš„ç³»ç»Ÿæç¤ºæ¥å¤„ç†èˆªç­æ›´æ–°ä»»åŠ¡ã€‚å·¥å…·åˆ†ä¸ºå®‰å…¨å·¥å…·å’Œæ•æ„Ÿå·¥å…·ä¸¤ç»„ï¼Œé€šè¿‡ä¸åŒçš„è·¯ç”±é€»è¾‘å¤„ç†ã€‚

### 2.3 ç§Ÿè½¦åŠ©æ‰‹ (Car Rental Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†ç§Ÿè½¦é¢„è®¢ã€ä¿®æ”¹å’Œå–æ¶ˆã€‚
- **å·¥å…·**ï¼š
  - **å®‰å…¨å·¥å…·**ï¼š
    - `search_car_rentals`ï¼šæœç´¢å¯ç”¨è½¦è¾†ã€‚
    - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚
  - **æ•æ„Ÿå·¥å…·**ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
    - `book_car_rental`ï¼šé¢„è®¢è½¦è¾†ã€‚
    - `update_car_rental`ï¼šæ›´æ–°ç§Ÿè½¦ä¿¡æ¯ï¼ˆå¦‚æ—¥æœŸï¼‰ã€‚
    - `cancel_car_rental`ï¼šå–æ¶ˆç§Ÿè½¦ã€‚

### 2.4 é…’åº—é¢„è®¢åŠ©æ‰‹ (Hotel Booking Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†é…’åº—é¢„è®¢ã€ä¿®æ”¹å’Œå–æ¶ˆã€‚
- **å·¥å…·**ï¼š
  - **å®‰å…¨å·¥å…·**ï¼š
    - `search_hotels`ï¼šæœç´¢å¯ç”¨é…’åº—ã€‚
    - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚
  - **æ•æ„Ÿå·¥å…·**ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
    - `book_hotel`ï¼šé¢„è®¢é…’åº—ã€‚
    - `update_hotel`ï¼šæ›´æ–°é…’åº—é¢„è®¢ï¼ˆå¦‚æ—¥æœŸï¼‰ã€‚
    - `cancel_hotel`ï¼šå–æ¶ˆé…’åº—é¢„è®¢ã€‚

### 2.5 è¡Œç¨‹æ¨èåŠ©æ‰‹ (Excursion Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†è¡Œç¨‹æ¨èå’Œå…¶ä»–æ´»åŠ¨çš„é¢„è®¢ã€ä¿®æ”¹å’Œå–æ¶ˆã€‚
- **å·¥å…·**ï¼š
  - **å®‰å…¨å·¥å…·**ï¼š
    - `search_trip_recommendations`ï¼šæœç´¢è¡Œç¨‹æ¨èã€‚
    - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚
  - **æ•æ„Ÿå·¥å…·**ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
    - `book_excursion`ï¼šé¢„è®¢è¡Œç¨‹ã€‚
    - `update_excursion`ï¼šæ›´æ–°è¡Œç¨‹è¯¦æƒ…ã€‚
    - `cancel_excursion`ï¼šå–æ¶ˆè¡Œç¨‹ã€‚

### 2.6 WooCommerce åŠ©æ‰‹
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†ä¸ WooCommerce å•†åº—çš„äº¤äº’ã€‚
- **å·¥å…·**ï¼š
  - `search_products`ï¼šæ ¹æ®å…³é”®è¯æœç´¢äº§å“ã€‚
  - `search_orders`ï¼šæ ¹æ®é‚®ç®±ã€å§“åæˆ–è®¢å•IDæœç´¢è®¢å•ï¼ˆéœ€è¦éªŒè¯ï¼‰ã€‚
  - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚

### 2.7 è¡¨å•æäº¤åŠ©æ‰‹ (Form Submission Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†ç”¨æˆ·è¡¨å•æäº¤ã€‚
- **å·¥å…·**ï¼š
  - `submit_form`ï¼šæäº¤åŒ…å«ç”¨æˆ·å§“åã€é‚®ç®±ã€ä¸»é¢˜ç­‰ä¿¡æ¯çš„è¡¨å•ã€‚
  - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚

### 2.8 åšå®¢æœç´¢åŠ©æ‰‹ (Blog Search Assistant)
- **åŠŸèƒ½**ï¼šä¸“é—¨å¤„ç†åšå®¢æ–‡ç« æœç´¢ã€‚
- **å·¥å…·**ï¼š
  - `search_blog_posts`ï¼šæ ¹æ®å…³é”®è¯æœç´¢åšå®¢æ–‡ç« ã€‚
  - `CompleteOrEscalate`ï¼šå®Œæˆä»»åŠ¡æˆ–å‡çº§åˆ°ä¸»åŠ©æ‰‹ã€‚

## 3. æ•°æ®æºä¸å‘é‡æ•°æ®åº“

### 3.1 æ—…è¡Œæ•°æ®åº“ (Travel Database)
- ä½¿ç”¨ SQLite æ•°æ®åº“ (`travel2.sqlite`) å­˜å‚¨èˆªç­ã€é¢„è®¢ã€ä¹˜å®¢ç­‰æ—…è¡Œç›¸å…³æ•°æ®ã€‚

### 3.2 Qdrant å‘é‡æ•°æ®åº“
- ä½¿ç”¨ Qdrant å­˜å‚¨å’ŒæŸ¥è¯¢æ—…è¡Œæ•°æ®åº“å†…å®¹çš„å‘é‡åµŒå…¥ï¼Œä»¥æ”¯æŒé«˜æ•ˆçš„è¯­ä¹‰æœç´¢ã€‚

## 4. ç³»ç»Ÿæ¶æ„ä¸ä»£ç å®ç°

### 4.1 åŠ©æ‰‹åŸºç±»è®¾è®¡
æ‰€æœ‰åŠ©æ‰‹éƒ½ç»§æ‰¿è‡ª <mcsymbol name="Assistant" filename="assistant_base.py" path="customer_support_chat/app/services/assistants/assistant_base.py" startline="18" type="class"></mcsymbol> åŸºç±»ï¼Œè¯¥åŸºç±»æä¾›äº†ç»Ÿä¸€çš„è°ƒç”¨æ¥å£å’Œé”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
class Assistant:
    def __init__(self, runnable: Runnable):
        self.runnable = runnable

    def __call__(self, state: State, config: Optional[RunnableConfig] = None):
        while True:
            result = self.runnable.invoke(state, config)
            # å¤„ç†ç©ºå“åº”å’Œå·¥å…·è°ƒç”¨
            if not result.tool_calls and (not result.content or 
               isinstance(result.content, list) and not result.content[0].get("text")):
                messages = state["messages"] + [("user", "Respond with a real output.")]
                state = {**state, "messages": messages}
            else:
                break
        return {"messages": result}
```

### 4.2 å·¥å…·å®ç°æ¨¡å¼
æ‰€æœ‰å·¥å…·éƒ½ä½¿ç”¨ LangChain çš„ `@tool` è£…é¥°å™¨å®šä¹‰ï¼Œéµå¾ªç»Ÿä¸€çš„å‚æ•°è§„èŒƒå’Œé”™è¯¯å¤„ç†ï¼š

```python
@tool
def search_flights(query: str, limit: int = 2) -> List[Dict]:
    """Search for flights based on a natural language query."""
    search_results = flights_vectordb.search(query, limit=limit)
    
    flights = []
    for result in search_results:
        payload = result.payload
        flights.append({
            "flight_id": payload["flight_id"],
            "flight_no": payload["flight_no"],
            "departure_airport": payload["departure_airport"],
            "arrival_airport": payload["arrival_airport"],
            "scheduled_departure": payload["scheduled_departure"],
            "scheduled_arrival": payload["scheduled_arrival"],
            "status": payload["status"],
            "aircraft_code": payload["aircraft_code"],
            "actual_departure": payload["actual_departure"],
            "actual_arrival": payload["actual_arrival"],
            "chunk": payload["content"],
            "similarity": result.score,
        })
    return flights
```

### 4.3 çŠ¶æ€ç®¡ç†
ç³»ç»ŸçŠ¶æ€åœ¨ <mcfile name="state.py" path="customer_support_chat/app/core/state.py"></mcfile> ä¸­å®šä¹‰ï¼Œä½¿ç”¨ TypedDict ç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```python
class State(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    user_info: str
    dialog_state: Annotated[
        list[
            Literal[
                "assistant",
                "update_flight",
                "book_car_rental",
                "book_hotel",
                "book_excursion",
            ]
        ],
        update_dialog_stack,
    ]
```

### 4.4 å·¥ä½œæµå›¾æ„å»º
ç³»ç»Ÿä½¿ç”¨ LangGraph æ„å»ºå·¥ä½œæµï¼Œåœ¨ <mcfile name="graph.py" path="customer_support_chat/app/graph.py"></mcfile> ä¸­å®šä¹‰ï¼š

```python
# åˆå§‹åŒ–å›¾
builder = StateGraph(State)

# æ·»åŠ ç”¨æˆ·ä¿¡æ¯è·å–èŠ‚ç‚¹
builder.add_node("fetch_user_info", user_info)
builder.add_edge(START, "fetch_user_info")

# æ·»åŠ å®‰å…¨æ£€æŸ¥èŠ‚ç‚¹
builder.add_node("guardrail_check", guardrail_check)
builder.add_edge("fetch_user_info", "guardrail_check")

# æ·»åŠ èˆªç­åŠ©æ‰‹ç›¸å…³èŠ‚ç‚¹
builder.add_node("enter_update_flight", create_entry_node("Flight Updates & Booking Assistant", "update_flight"))
builder.add_node("update_flight", flight_booking_assistant)
builder.add_edge("enter_update_flight", "update_flight")

# æ·»åŠ å·¥å…·èŠ‚ç‚¹
builder.add_node("update_flight_safe_tools", create_tool_node_with_fallback(update_flight_safe_tools))
builder.add_node("update_flight_sensitive_tools", create_tool_node_with_fallback(update_flight_sensitive_tools))

# å®šä¹‰è·¯ç”±é€»è¾‘
def route_update_flight_tools(state: State) -> Literal["update_flight", "primary_assistant"]:
    return "primary_assistant" if should_route_to_primary(state) else "update_flight"
```

### 4.5 å·¥å…·èŠ‚ç‚¹åˆ›å»ºä¸é”™è¯¯å¤„ç†
å·¥å…·èŠ‚ç‚¹ä½¿ç”¨ <mcsymbol name="create_tool_node_with_fallback" filename="utils.py" path="customer_support_chat/app/services/utils.py" startline="135" type="function"></mcsymbol> å‡½æ•°åˆ›å»ºï¼ŒåŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
def create_tool_node_with_fallback(tools: list):
    from langchain_core.messages import ToolMessage
    from langchain_core.runnables import RunnableLambda
    from langgraph.prebuilt import ToolNode

    return ToolNode(tools).with_fallbacks(
        [RunnableLambda(handle_tool_error)], exception_key="error"
    )

# é”™è¯¯å¤„ç†å‡½æ•°
def handle_tool_error(state) -> dict:
    error = state.get("error")
    tool_calls = state["messages"][-1].tool_calls
    return {
        "messages": [
            {
                "type": "tool",
                "content": f"Error: {repr(error)}\nPlease fix your mistakes.",
                "tool_call_id": tc["id"],
            }
            for tc in tool_calls
        ]
    }
```

### 4.6 å…¥å£èŠ‚ç‚¹åˆ›å»º
åŠ©æ‰‹å…¥å£èŠ‚ç‚¹ä½¿ç”¨ <mcsymbol name="create_entry_node" filename="utils.py" path="customer_support_chat/app/services/utils.py" startline="12" type="function"></mcsymbol> å‡½æ•°åˆ›å»ºï¼š

```python
def create_entry_node(assistant_name: str, new_dialog_state: str) -> Callable:
    def entry_node(state: State) -> dict:
        # å¤„ç†æ‰€æœ‰å·¥å…·è°ƒç”¨
        last_message = state["messages"][-1]
        tool_messages = []
        
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            for tool_call in last_message.tool_calls:
                tool_messages.append(
                    ToolMessage(
                        content=(
                            f"The assistant is now the {assistant_name}. Reflect on the above conversation between the host assistant and the user. "
                            f"The user's intent is unsatisfied. Use the provided tools to assist the user. Remember, you are {assistant_name}, "
                            "and the booking, update, or other action is not complete until after you have successfully invoked the appropriate tool. "
                            "If the user changes their mind or needs help for other tasks, call the CompleteOrEscalate function to let the primary host assistant take control. "
                            "Do not mention who you areâ€”just act as the proxy for the assistant."
                        ),
                        tool_call_id=tool_call["id"],
                    )
                )
        else:
            # å›é€€å¤„ç†
            tool_messages.append(
                ToolMessage(
                    content=(
                        f"The assistant is now the {assistant_name}. Reflect on the above conversation between the host assistant and the user. "
                        f"The user's intent is unsatisfied. Use the provided tools to assist the user. Remember, you are {assistant_name}, "
                        "and the booking, update, or other action is not complete until after you have successfully invoked the appropriate tool. "
                        "If the user changes their mind or needs help for other tasks, call the CompleteOrEscalate function to let the primary host assistant take control. "
                        "Do not mention who you areâ€”just act as the proxy for the assistant."
                    ),
                    tool_call_id="fallback_tool_call_id",
                )
            )
        
        return {
            "messages": tool_messages,
            "dialog_state": new_dialog_state,
        }
    return entry_node
```

### 4.7 æ•æ„Ÿæ“ä½œç¡®è®¤æœºåˆ¶
ç³»ç»Ÿé€šè¿‡æ£€æŸ¥å·¥å…·è°ƒç”¨ç±»å‹æ¥å®ç°æ•æ„Ÿæ“ä½œç¡®è®¤ï¼š

```python
def route_update_flight(state: State) -> Literal[
    "update_flight_safe_tools",
    "update_flight_sensitive_tools",
    "primary_assistant",
    "__end__",
]:
    route = tools_condition(state)
    if route == END:
        return END
    tool_calls = state["messages"][-1].tool_calls
    safe_toolnames = [t.name for t in update_flight_safe_tools]
    if all(tc["name"] in safe_toolnames for tc in tool_calls):
        return "update_flight_safe_tools"
    return "update_flight_sensitive_tools"
```

## 5. å…³é”®è®¾è®¡æ¨¡å¼

### 5.1 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
åŠ©æ‰‹åŸºç±» <mcsymbol name="Assistant" filename="assistant_base.py" path="customer_support_chat/app/services/assistants/assistant_base.py" startline="18" type="class"></mcsymbol> å®ç°äº†ç­–ç•¥æ¨¡å¼ï¼Œæ¯ä¸ªå…·ä½“åŠ©æ‰‹æä¾›ä¸åŒçš„ runnable å®ç°ã€‚

### 5.2 è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)
ä¸»åŠ©æ‰‹é€šè¿‡å§”æ´¾å·¥å…·å°†ä»»åŠ¡ä¼ é€’ç»™ä¸“é—¨åŠ©æ‰‹ï¼Œå½¢æˆè´£ä»»é“¾ï¼š

```python
class ToFlightBookingAssistant(BaseModel):
    """Transfers work to a specialized assistant to handle flight updates and cancellations."""
    request: str = Field(description="Any necessary follow-up questions the update flight assistant should clarify before proceeding.")
```

### 5.3 å·¥å‚æ–¹æ³•æ¨¡å¼ (Factory Method)
å·¥å…·èŠ‚ç‚¹åˆ›å»ºä½¿ç”¨å·¥å‚æ–¹æ³•ï¼š

```python
def create_tool_node_with_fallback(tools):
    """Create a tool node with fallback handling for tool execution errors."""
    # å®ç°ç»†èŠ‚...
```

## 6. å¼€å‘æŒ‡å—

### 6.1 æ·»åŠ æ–°åŠ©æ‰‹
1. åœ¨ <mcfolder name="assistants" path="customer_support_chat/app/services/assistants"></mcfolder> ç›®å½•ä¸‹åˆ›å»ºæ–°çš„åŠ©æ‰‹æ–‡ä»¶
2. å®šä¹‰åŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºå’Œå·¥å…·åˆ—è¡¨
3. åœ¨ <mcfile name="__init__.py" path="customer_support_chat/app/services/assistants/__init__.py"></mcfile> ä¸­å¯¼å‡ºæ–°åŠ©æ‰‹
4. åœ¨ <mcfile name="graph.py" path="customer_support_chat/app/graph.py"></mcfile> ä¸­æ·»åŠ ç›¸åº”çš„å›¾èŠ‚ç‚¹å’Œè·¯ç”±é€»è¾‘

### 6.2 æ·»åŠ æ–°å·¥å…·
1. åœ¨ <mcfolder name="tools" path="customer_support_chat/app/services/tools"></mcfolder> ç›®å½•ä¸‹åˆ›å»ºæ–°çš„å·¥å…·æ–‡ä»¶
2. ä½¿ç”¨ `@tool` è£…é¥°å™¨å®šä¹‰å·¥å…·å‡½æ•°
3. åœ¨ <mcfile name="__init__.py" path="customer_support_chat/app/services/tools/__init__.py"></mcfile> ä¸­å¯¼å‡ºæ–°å·¥å…·
4. åœ¨ç›¸åº”çš„åŠ©æ‰‹æ–‡ä»¶ä¸­å¯¼å…¥å¹¶ä½¿ç”¨æ–°å·¥å…·

### 6.3 è°ƒè¯•ä¸ç›‘æ§
ç³»ç»Ÿé›†æˆäº† LangSmith è¿›è¡Œå¯è§‚å¯Ÿæ€§ç›‘æ§ï¼š
- è·Ÿè¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
- ç›‘æ§å·¥å…·ä½¿ç”¨æƒ…å†µ
- è®°å½•ä»£ç†å“åº”å’Œé”™è¯¯
- æ€§èƒ½åˆ†æå’Œè°ƒè¯•

## 7. ç³»ç»Ÿä½¿ç”¨æ–¹æ³•

### 7.1 å¯åŠ¨ç³»ç»Ÿ
1. ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ï¼š`poetry install`
2. å¯åŠ¨ Qdrant å‘é‡æ•°æ®åº“ï¼š`docker compose up qdrant -d`
3. è¿è¡Œå®¢æˆ·æ”¯æŒèŠå¤©ç³»ç»Ÿï¼š`poetry run python ./customer_support_chat/app/main.py`

### 7.2 ä¸ç³»ç»Ÿäº¤äº’
- å¯åŠ¨åï¼Œç³»ç»Ÿä¼šæç¤ºç”¨æˆ·è¾“å…¥é—®é¢˜ã€‚
- ç”¨æˆ·å¯ä»¥è¯¢é—®èˆªç­ä¿¡æ¯ã€é¢„è®¢æœåŠ¡ã€æŸ¥è¯¢æ”¿ç­–ç­‰ã€‚
- ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®æŸ¥è¯¢å†…å®¹å§”æ´¾ç»™ç›¸åº”çš„åŠ©æ‰‹å¤„ç†ã€‚
- å¯¹äºæ¶‰åŠä¿®æ”¹ã€å–æ¶ˆç­‰æ•æ„Ÿæ“ä½œï¼Œç³»ç»Ÿä¼šæš‚åœå¹¶è¯·æ±‚ç”¨æˆ·ç¡®è®¤ã€‚

## 8. å®‰å…¨ä¸ç¡®è®¤æœºåˆ¶

ç³»ç»ŸåŒ…å«ä¸‰å±‚å®‰å…¨æœºåˆ¶æ¥ä¿éšœç”¨æˆ·æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šè¿è¡Œï¼š

1.  **æ•æ„Ÿæ“ä½œç¡®è®¤æœºåˆ¶**ï¼šç³»ç»Ÿå¯¹æ‰€æœ‰å¯èƒ½ä¿®æ”¹ç”¨æˆ·æ•°æ®çš„æ“ä½œï¼ˆå¦‚æ›´æ–°/å–æ¶ˆèˆªç­ã€é¢„è®¢/å–æ¶ˆé…’åº—ç­‰ï¼‰éƒ½æ ‡è®°ä¸º"æ•æ„Ÿå·¥å…·"ã€‚å½“è¿™äº›å·¥å…·è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœå·¥ä½œæµï¼Œå¹¶æ˜ç¡®æç¤ºç”¨æˆ·è¿›è¡Œç¡®è®¤ï¼Œåªæœ‰åœ¨ç”¨æˆ·åŒæ„åæ‰ä¼šç»§ç»­æ‰§è¡Œæ“ä½œã€‚

2.  **å®‰å…¨æŠ¤æ æœºåˆ¶**ï¼šç³»ç»Ÿåœ¨å¤„ç†ç”¨æˆ·è¾“å…¥å‰ï¼Œä¼šé€šè¿‡ä¸“é—¨çš„AIä»£ç†è¿›è¡Œå®‰å…¨æ£€æŸ¥ã€‚
    *   **è¶Šç‹±é˜²æŠ¤**ï¼šæ£€æµ‹ç”¨æˆ·æ˜¯å¦è¯•å›¾ç»•è¿‡ç³»ç»ŸæŒ‡ä»¤æˆ–è¿›è¡Œè¶Šç‹±æ”»å‡»ï¼ˆå¦‚è¯¢é—®ç³»ç»Ÿæç¤ºè¯ã€æ³¨å…¥æ¶æ„ä»£ç ç­‰ï¼‰ã€‚å¦‚æœæ£€æµ‹åˆ°è¶Šç‹±è¡Œä¸ºï¼Œç³»ç»Ÿå°†æ‹’ç»å“åº”å¹¶æç¤ºç”¨æˆ·ã€‚
    *   **ç›¸å…³æ€§æ£€æŸ¥**ï¼šæ£€æµ‹ç”¨æˆ·çš„æœ€æ–°æ¶ˆæ¯æ˜¯å¦ä¸å®¢æœç³»ç»Ÿçš„ä¸šåŠ¡èŒƒå›´ï¼ˆèˆªç­ã€ç§Ÿè½¦ã€é…’åº—ã€ç”µå•†ã€è¡¨å•ã€åšå®¢ç­‰ï¼‰é«˜åº¦ç›¸å…³ã€‚å¯¹äºä¸ç›¸å…³çš„è¾“å…¥ï¼Œç³»ç»Ÿä¼šè®°å½•æ—¥å¿—æˆ–å‘å‡ºè­¦å‘Šï¼ˆæ ¹æ®å…·ä½“ç­–ç•¥å¤„ç†ï¼‰ã€‚

3.  **äººå·¥å®¡æ ¸æœºåˆ¶ (GoHumanLoop)**ï¼šå¯¹äºæ‰€æœ‰æ ‡è®°ä¸º"æ•æ„Ÿå·¥å…·"çš„æ“ä½œï¼Œåœ¨ç”¨æˆ·ç¡®è®¤åï¼Œç³»ç»Ÿè¿˜ä¼šé€šè¿‡ GoHumanLoop æ¡†æ¶å°†æ“ä½œè¯·æ±‚å‘é€ç»™ç³»ç»Ÿç®¡ç†å‘˜è¿›è¡Œæœ€ç»ˆå®¡æ ¸ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡é£ä¹¦ç­‰å¹³å°æ¥æ”¶å®¡æ ¸é€šçŸ¥ï¼Œå¹¶å†³å®šæ˜¯å¦æ‰¹å‡†è¯¥æ“ä½œã€‚åªæœ‰åœ¨ç®¡ç†å‘˜æ‰¹å‡†åï¼Œæ“ä½œæ‰ä¼šçœŸæ­£æ‰§è¡Œï¼Œè¿›ä¸€æ­¥æå‡äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚

**ä»£ç å®ç°è¯´æ˜ï¼š**

å®‰å…¨æŠ¤æ åŠŸèƒ½åœ¨ `customer_support_chat/app/services/guardrails/` æ¨¡å—ä¸­å®ç°ã€‚

### 1. å®‰å…¨æ£€æŸ¥ä»£ç†å®šä¹‰
åœ¨ `guardrail_agents.py` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªç‹¬ç«‹çš„AIä»£ç†ï¼š

```python
# è¶Šç‹±é˜²æŠ¤ä»£ç†
jailbreak_guardrail_agent = ChatOpenAI(
    model="gpt-4o-mini",
    openai_api_key=settings.OPENAI_API_KEY,
    temperature=0, # ç¡®ä¿è¾“å‡ºç¨³å®š
).with_structured_output(JailbreakOutput)

# ç›¸å…³æ€§æ£€æŸ¥ä»£ç†
relevance_guardrail_agent = ChatOpenAI(
    model="gpt-4o-mini",
    openai_api_key=settings.OPENAI_API_KEY,
    temperature=0, # ç¡®ä¿è¾“å‡ºç¨³å®š
).with_structured_output(RelevanceOutput)
```

### 2. å®‰å…¨æ£€æŸ¥èŠ‚ç‚¹å®ç°
åœ¨ `graph.py` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸º `guardrail_check` çš„æ–°èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¼šåœ¨ä¸»åŠ©æ‰‹å¤„ç†ç”¨æˆ·è¯·æ±‚ä¹‹å‰æ‰§è¡Œå®‰å…¨æ£€æŸ¥ï¼š

```python
def guardrail_check(state: State, config: RunnableConfig):
    """Node to check user input for safety and relevance."""
    # è·å–æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯
    user_messages = [msg for msg in state["messages"] if isinstance(msg, HumanMessage)]
    if not user_messages:
        logger.warning("No user message found for guardrail check. Allowing.")
        return {
            "messages": [HumanMessage(content="No user input to check. Please provide a query.")]
        }
    
    latest_user_message = user_messages[-1]
    user_input = latest_user_message.content
    
    logger.info(f"ğŸ›¡ï¸ Checking safety and relevance for user input: '{user_input}'")
    
    # 1. æ£€æŸ¥è¶Šç‹±è¡Œä¸º
    jailbreak_prompt = f"{jailbreak_guardrail_agent_instructions}

User Input: {user_input}"
    jailbreak_result = jailbreak_guardrail_agent.invoke(jailbreak_prompt)
    
    if not jailbreak_result.is_safe:
        logger.warning(f"ğŸš¨ Jailbreak attempt detected: {jailbreak_result.reasoning}")
        # å¦‚æœæ£€æµ‹åˆ°è¶Šç‹±è¡Œä¸ºï¼Œç›´æ¥è¿”å›æ‹’ç»ä¿¡æ¯å¹¶ç»“æŸå¯¹è¯
        return {
            "messages": [HumanMessage(content=f"I cannot assist with that request. Reason: {jailbreak_result.reasoning}")]
        }

    # 2. æ£€æŸ¥ç›¸å…³æ€§
    relevance_prompt = f"{relevance_guardrail_agent_instructions}

User Input: {user_input}"
    relevance_result = relevance_guardrail_agent.invoke(relevance_prompt)
    
    if not relevance_result.is_relevant:
        logger.warning(f"âš ï¸ Irrelevant input detected: {relevance_result.reasoning}")
        # å¯¹äºä¸ç›¸å…³è¾“å…¥ï¼Œå¯ä»¥é€‰æ‹©è®°å½•æ—¥å¿—æˆ–è¿”å›æç¤ºä¿¡æ¯
        
    # å¦‚æœä¸¤é¡¹æ£€æŸ¥éƒ½é€šè¿‡ï¼Œåˆ™ç»§ç»­æ­£å¸¸æµç¨‹
    logger.info("âœ… Input passed safety and relevance checks.")
    return {"messages": []} # æ— æ–°æ¶ˆæ¯æ·»åŠ ï¼Œç»§ç»­æµç¨‹
```

### 3. å·¥ä½œæµé›†æˆ
åœ¨ `graph.py` ä¸­ï¼Œæˆ‘ä»¬å°†å®‰å…¨æ£€æŸ¥èŠ‚ç‚¹é›†æˆåˆ°ä¸»å·¥ä½œæµä¸­ï¼Œç¡®ä¿å®ƒåœ¨è·å–ç”¨æˆ·ä¿¡æ¯åã€ä¸»åŠ©æ‰‹å¤„ç†å‰æ‰§è¡Œï¼š

```python
# æ·»åŠ å®‰å…¨æ£€æŸ¥èŠ‚ç‚¹
builder.add_node("guardrail_check", guardrail_check)

# å®šä¹‰å·¥ä½œæµè¾¹
builder.add_edge(START, "fetch_user_info")
builder.add_edge("fetch_user_info", "guardrail_check")
# å®‰å…¨æ£€æŸ¥é€šè¿‡åï¼Œè¿æ¥åˆ°ä¸»åŠ©æ‰‹
builder.add_edge("guardrail_check", "primary_assistant")
```

### 4. äººå·¥å®¡æ ¸æœºåˆ¶å®ç°
äººå·¥å®¡æ ¸åŠŸèƒ½é€šè¿‡ GoHumanLoop æ¡†æ¶å®ç°ã€‚åœ¨ `customer_support_chat/app/core/humanloop_manager.py` ä¸­åˆå§‹åŒ–äº† GoHumanLoop ç®¡ç†å™¨å’Œé€‚é…å™¨ï¼š

```python
# åˆ›å»º GoHumanLoopManager å®ä¾‹
humanloop_manager = DefaultHumanLoopManager(
    APIProvider(
        name="ApiProvider",
        api_base_url="http://127.0.0.1:9800/api", # æ¢æˆè‡ªå·±é£ä¹¦åº”ç”¨çš„URL
        api_key=get_secret_from_env("GOHUMANLOOP_API_KEY"),
        default_platform="feishu"
    )
)
# åˆ›å»º LangGraphAdapter å®ä¾‹
humanloop_adapter = HumanloopAdapter(
    manager=humanloop_manager,
    default_timeout=300,  # é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º5åˆ†é’Ÿ
)
```

æ‰€æœ‰éœ€è¦äººå·¥å®¡æ ¸çš„æ•æ„Ÿå·¥å…·ï¼ˆå¦‚ `update_ticket_to_new_flight`, `cancel_ticket`, `book_hotel` ç­‰ï¼‰éƒ½ä¼šä½¿ç”¨ `@humanloop_adapter.require_approval(execute_on_reject=False)` è£…é¥°å™¨è¿›è¡Œè£…é¥°ã€‚å½“è¿™äº›å·¥å…·è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœæ‰§è¡Œï¼Œå¹¶é€šè¿‡ GoHumanLoop å°†å®¡æ ¸è¯·æ±‚å‘é€ç»™ç®¡ç†å‘˜ï¼š

```python
@tool
@humanloop_adapter.require_approval(execute_on_reject=False)
async def update_ticket_to_new_flight(
    ticket_no: str, new_flight_id: int, *, config: RunnableConfig, approval_result=None
) -> str:
    """Update the user's ticket to a new valid flight."""
    # å¦‚æœå®¡æ‰¹è¢«æ‹’ç»ï¼Œæ­¤å‡½æ•°ä½“ä¸ä¼šæ‰§è¡Œã€‚
    # å¦‚æœå®¡æ‰¹é€šè¿‡ï¼Œapproval_result å°†åŒ…å«å®¡æ‰¹è¯¦æƒ…ã€‚
    # ... (å·¥å…·çš„å…·ä½“å®ç°)
```

é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œç³»ç»Ÿåœ¨å¤„ç†æ¯ä¸ªç”¨æˆ·è¯·æ±‚æ—¶éƒ½ä¼šå…ˆè¿›è¡Œä¸¥æ ¼çš„å®‰å…¨æ£€æŸ¥ï¼Œå¹¶å¯¹æ‰€æœ‰æ•æ„Ÿæ“ä½œè¿›è¡ŒåŒé‡ç¡®è®¤ï¼ˆç”¨æˆ·ç¡®è®¤ + ç®¡ç†å‘˜å®¡æ ¸ï¼‰ï¼Œä»è€Œæœ‰æ•ˆé˜²æ­¢æ¶æ„æ”»å‡»ã€æ— å…³å¯¹è¯å’Œæœªç»æˆæƒçš„æ•°æ®ä¿®æ”¹ï¼Œå…¨é¢æå‡äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚

## 9. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‘é‡æœç´¢ä¼˜åŒ–**ï¼šè°ƒæ•´ Qdrant çš„æœç´¢å‚æ•°å’Œç´¢å¼•é…ç½®
2. **æ•°æ®åº“è¿æ¥æ± **ï¼šä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
3. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„ç»“æœå®æ–½ç¼“å­˜
4. **å¼‚æ­¥å¤„ç†**ï¼šå¯¹è€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†
5. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®æ€§èƒ½ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦æœºåˆ¶

## 10. é¡¹ç›®ç»“æ„ä¸ä¾èµ–ç®¡ç†

### 10.1 é¡¹ç›®ç»“æ„
```
customer_support_chat/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ settings.py       # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ state.py          # çŠ¶æ€å®šä¹‰
â”‚   â”‚   â””â”€â”€ logger.py         # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ assistants/       # åŠ©æ‰‹å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ assistant_base.py
â”‚   â”‚   â”‚   â”œâ”€â”€ primary_assistant.py
â”‚   â”‚   â”‚   â”œâ”€â”€ flight_booking_assistant.py
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ tools/           # å·¥å…·å®ç°
â”‚   â”‚       â”œâ”€â”€ flights.py
â”‚   â”‚       â”œâ”€â”€ hotels.py
â”‚   â”‚       â”œâ”€â”€ cars.py
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ graph.py             # å·¥ä½œæµå›¾å®šä¹‰
â”‚   â””â”€â”€ main.py              # ä¸»ç¨‹åºå…¥å£
â””â”€â”€ data/                    # æ•°æ®æ–‡ä»¶
```

### 10.2 ä¾èµ–ç®¡ç†
é¡¹ç›®ä½¿ç”¨ Poetry è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œä¸»è¦ä¾èµ–åŒ…æ‹¬ï¼š

```toml
[tool.poetry.dependencies]
langgraph = "^0.2.19"          # å·¥ä½œæµå›¾æ¡†æ¶
langchain-openai = "^0.1.23"    # OpenAI é›†æˆ
langchain-community = "^0.2.16" # ç¤¾åŒºå·¥å…·
qdrant-client = "^1.11.1"       # å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯
pandas = "^2.2.2"              # æ•°æ®å¤„ç†
fastapi = "^0.116.1"           # Web æ¡†æ¶
uvicorn = "^0.35.0"            # ASGI æœåŠ¡å™¨
```

### 10.3 ç¯å¢ƒé…ç½®
ç³»ç»Ÿé…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œåœ¨ <mcfile name="settings.py" path="customer_support_chat/app/core/settings.py"></mcfile> ä¸­å®šä¹‰ï¼š

```python
class Config:
    OPENAI_API_KEY: str = environ.get("OPENAI_API_KEY", "")
    OPENAI_BASE_URL: str = environ.get("OPENAI_BASE_URL", "")
    OPENAI_MODEL: str = environ.get("OPENAI_MODEL", "gpt-3.5-turbo")
    MAX_TOKENS: int = int(environ.get("MAX_TOKENS", "1000"))
    SQLITE_DB_PATH: str = environ.get("SQLITE_DB_PATH", "./customer_support_chat/data/travel2.sqlite")
    QDRANT_URL: str = environ.get("QDRANT_URL", "http://localhost:6333")
    # WooCommerce å’Œè¡¨å•æäº¤APIé…ç½®
    WOOCOMMERCE_CONSUMER_KEY: str = environ.get("WOOCOMMERCE_CONSUMER_KEY", "")
    WOOCOMMERCE_CONSUMER_SECRET: str = environ.get("WOOCOMMERCE_CONSUMER_SECRET", "")
    WOOCOMMERCE_API_URL: str = environ.get("WOOCOMMERCE_API_URL", "")
```

## 11. å¼€å‘ä¸éƒ¨ç½²æŒ‡å—

### 11.1 å¼€å‘ç¯å¢ƒè®¾ç½®
1. å®‰è£… Poetryï¼š`pip install poetry`
2. å®‰è£…ä¾èµ–ï¼š`poetry install`
3. é…ç½®ç¯å¢ƒå˜é‡ï¼šå¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™å®é™…å€¼
4. å¯åŠ¨ Qdrantï¼š`docker compose up qdrant -d`
5. è¿è¡Œç³»ç»Ÿï¼š`poetry run python ./customer_support_chat/app/main.py`

### 11.2 æµ‹è¯•ä¸è°ƒè¯•
- ä½¿ç”¨ LangSmith è¿›è¡Œè¯·æ±‚è·Ÿè¸ªå’Œè°ƒè¯•
- è®¾ç½® `LOG_LEVEL=DEBUG` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- ä½¿ç”¨ IPython è¿›è¡Œäº¤äº’å¼è°ƒè¯•

### 11.3 ç”Ÿäº§éƒ¨ç½²
1. ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²
2. é…ç½®ç¯å¢ƒå˜é‡ç”¨äºç”Ÿäº§ç¯å¢ƒ
3. è®¾ç½®é€‚å½“çš„æ—¥å¿—çº§åˆ«å’Œç›‘æ§
4. é…ç½®åå‘ä»£ç†å’ŒSSLè¯ä¹¦

## 12. æ‰©å±•æ€§è€ƒè™‘

ç³»ç»Ÿè®¾è®¡å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼š
- æ¨¡å—åŒ–æ¶æ„ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½æ¨¡å—
- ç»Ÿä¸€çš„åŠ©æ‰‹æ¥å£ä¾¿äºé›†æˆæ–°çš„AIæ¨¡å‹
- æ ‡å‡†åŒ–çš„å·¥å…·å®šä¹‰ä¾¿äºæ·»åŠ æ–°çš„ä¸šåŠ¡èƒ½åŠ›
- çµæ´»çš„è·¯ç”±æœºåˆ¶æ”¯æŒå¤æ‚çš„ä¸šåŠ¡æµç¨‹
- é…ç½®é©±åŠ¨çš„è®¾è®¡ä¾¿äºç¯å¢ƒé€‚é…
- å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ä¿éšœç³»ç»Ÿç¨³å®šæ€§
- æ–°å¢çš„å®‰å…¨æŠ¤æ æœºåˆ¶å’Œäººå·¥å®¡æ ¸æœºåˆ¶ä¸ºç³»ç»Ÿæä¾›äº†æ›´å¼ºçš„å®‰å…¨æ€§å’Œå¯æ§æ€§ï¼ŒåŒæ—¶ä¹Ÿä¸ºæœªæ¥å¢åŠ æ›´å¤šç±»å‹çš„æ£€æŸ¥ï¼ˆå¦‚å†…å®¹è¿‡æ»¤ã€æƒ…æ„Ÿåˆ†æç­‰ï¼‰å’Œæ›´å¤æ‚çš„å®¡æ‰¹æµç¨‹æä¾›äº†å¯æ‰©å±•çš„åŸºç¡€ã€‚