# 多智能体RAG客服系统功能说明文档

## 1. 项目概述

本项目实现了一个基于多智能体（Multi-Agent）和检索增强生成（Retrieval-Augmented Generation, RAG）技术的客户支持系统。它利用 Python、LangChain 和 LangGraph 构建了一个能够处理各种旅行相关查询的对话式 AI，包括航班预订、租车、酒店预订和行程推荐。

系统采用模块化架构，主要由一个主助手（Primary Assistant）和多个专门处理特定任务的子助手（Specialized Assistants）组成。这种设计使得系统能够根据用户需求灵活地在不同助手间切换，同时通过敏感操作确认机制和新增的安全护栏机制保障用户数据安全和系统稳定运行。

## 2. 核心功能模块

### 2.1 主助手 (Primary Assistant)
- **功能**：作为用户交互的入口点，处理通用查询，并根据用户需求将任务委派给相应的专门助手。
- **工具**：
  - `DuckDuckGoSearchResults`：用于网络搜索。
  - `search_flights`：搜索航班信息。
  - `lookup_policy`：查询公司政策。
  - 委派工具（将任务转交给专门助手）：
    - `ToFlightBookingAssistant`：处理航班更新和取消。
    - `ToBookCarRental`：处理租车预订。
    - `ToHotelBookingAssistant`：处理酒店预订、修改和取消。
    - `ToBookExcursion`：处理行程推荐和其他活动预订。
    - `ToWooCommerceProducts`：处理 WooCommerce 产品搜索。
    - `ToWooCommerceOrders`：处理 WooCommerce 订单搜索（需要用户提供邮箱或姓名验证）。
    - `ToFormSubmission`：处理用户表单提交。
    - `ToBlogSearch`：处理博客文章搜索。

### 2.2 航班预订助手 (Flight Booking Assistant)
- **功能**：专门处理航班更新和取消请求。
- **工具**：
  - **安全工具**：
    - `search_flights`：搜索航班。
    - `CompleteOrEscalate`：完成任务或升级到主助手。
  - **敏感工具**（需要用户确认）：
    - `update_ticket_to_new_flight`：更新机票到新航班。
    - `cancel_ticket`：取消机票。

### 2.3 租车助手 (Car Rental Assistant)
- **功能**：专门处理租车预订、修改和取消。
- **工具**：
  - **安全工具**：
    - `search_car_rentals`：搜索可用车辆。
    - `CompleteOrEscalate`：完成任务或升级到主助手。
  - **敏感工具**（需要用户确认）：
    - `book_car_rental`：预订车辆。
    - `update_car_rental`：更新租车信息（如日期）。
    - `cancel_car_rental`：取消租车。

### 2.4 酒店预订助手 (Hotel Booking Assistant)
- **功能**：专门处理酒店预订、修改和取消。
- **工具**：
  - **安全工具**：
    - `search_hotels`：搜索可用酒店。
    - `CompleteOrEscalate`：完成任务或升级到主助手。
  - **敏感工具**（需要用户确认）：
    - `book_hotel`：预订酒店。
    - `update_hotel`：更新酒店预订（如日期）。
    - `cancel_hotel`：取消酒店预订。

### 2.5 行程推荐助手 (Excursion Assistant)
- **功能**：专门处理行程推荐和其他活动的预订、修改和取消。
- **工具**：
  - **安全工具**：
    - `search_trip_recommendations`：搜索行程推荐。
    - `CompleteOrEscalate`：完成任务或升级到主助手。
  - **敏感工具**（需要用户确认）：
    - `book_excursion`：预订行程。
    - `update_excursion`：更新行程详情。
    - `cancel_excursion`：取消行程。

### 2.6 WooCommerce 助手
- **功能**：专门处理与 WooCommerce 商店的交互。
- **工具**：
  - `search_products`：根据关键词搜索产品。
  - `search_orders`：根据邮箱、姓名或订单ID搜索订单（需要验证）。
  - `CompleteOrEscalate`：完成任务或升级到主助手。

### 2.7 表单提交助手 (Form Submission Assistant)
- **功能**：专门处理用户表单提交。
- **工具**：
  - `submit_form`：提交包含用户姓名、邮箱、主题等信息的表单。
  - `CompleteOrEscalate`：完成任务或升级到主助手。

### 2.8 博客搜索助手 (Blog Search Assistant)
- **功能**：专门处理博客文章搜索。
- **工具**：
  - `search_blog_posts`：根据关键词搜索博客文章。
  - `CompleteOrEscalate`：完成任务或升级到主助手。

## 3. 数据源与向量数据库

### 3.1 旅行数据库 (Travel Database)
- 使用 SQLite 数据库 (`travel2.sqlite`) 存储航班、预订、乘客等旅行相关数据。

### 3.2 Qdrant 向量数据库
- 使用 Qdrant 存储和查询旅行数据库内容的向量嵌入，以支持高效的语义搜索。

## 4. 系统使用方法

### 4.1 启动系统
1. 确保已安装所有依赖项：`poetry install`
2. 启动 Qdrant 向量数据库：`docker compose up qdrant -d`
3. 运行客户支持聊天系统：`poetry run python ./customer_support_chat/app/main.py`

### 4.2 与系统交互
- 启动后，系统会提示用户输入问题。
- 用户可以询问航班信息、预订服务、查询政策等。
- 系统会自动根据查询内容委派给相应的助手处理。
- 对于涉及修改、取消等敏感操作，系统会暂停并请求用户确认。

### 4.3 各功能使用说明

#### 4.3.1 航班查询与管理
- **查询航班**：直接询问航班信息，如“我明天的航班是什么时候？”
- **更新航班**：请求更新航班，如“我想把我的航班改到后天。” 系统会委派给航班预订助手处理。
- **取消航班**：请求取消航班，如“请取消我的航班。” 系统会委派给航班预订助手处理，并在执行前请求确认。

#### 4.3.2 租车服务
- **预订租车**：询问租车服务，如“我想在巴黎租一辆车，从5月1日到5月5日。” 系统会委派给租车助手处理。
- **修改租车**：请求修改租车信息，如“我想把租车日期改到5月2日到5月6日。” 系统会委派给租车助手处理。
- **取消租车**：请求取消租车，如“请取消我的租车预订。” 系统会委派给租车助手处理，并在执行前请求确认。

#### 4.3.3 酒店预订
- **预订酒店**：询问酒店预订，如“我想在罗马订一个酒店，5月1日入住，5月3日退房。” 系统会委派给酒店预订助手处理。
- **修改酒店预订**：请求修改酒店信息，如“我想把酒店入住日期改到5月2日。” 系统会委派给酒店预订助手处理。
- **取消酒店预订**：请求取消酒店预订，如“请取消我的酒店预订。” 系统会委派给酒店预订助手处理，并在执行前请求确认。
- **查询酒店状态**：询问酒店预订状态，如“我的酒店预订状态如何？” 系统会委派给酒店预订助手处理。

#### 4.3.4 行程推荐
- **预订行程**：询问行程推荐，如“有什么推荐的罗马行程吗？” 系统会委派给行程推荐助手处理。
- **修改行程**：请求修改行程详情，如“我想修改这个行程的细节。” 系统会委派给行程推荐助手处理。
- **取消行程**：请求取消行程，如“请取消我预订的行程。” 系统会委派给行程推荐助手处理，并在执行前请求确认。

#### 4.3.5 WooCommerce 服务
- **搜索产品**：询问产品信息，如“你们有什么笔记本电脑？” 系统会委派给 WooCommerce 助手处理。
- **搜索订单**：请求查询订单，如“我想查一下我的订单。” 系统会要求用户提供邮箱或姓名进行验证，然后委派给 WooCommerce 助手处理。

#### 4.3.6 表单提交
- **提交表单**：请求提交表单，如“我想提交一个咨询。” 系统会委派给表单提交助手，收集必要信息（姓名、邮箱、主题）后提交。

#### 4.3.7 博客搜索
- **搜索博客**：询问博客内容，如“有关于退款政策的博客文章吗？” 系统会委派给博客搜索助手处理。

## 5. 安全与确认机制

系统包含三层安全机制来保障用户数据安全和系统稳定运行：

1.  **敏感操作确认机制**：系统对所有可能修改用户数据的操作（如更新/取消航班、预订/取消酒店等）都标记为“敏感工具”。当这些工具被调用时，系统会自动暂停工作流，并明确提示用户进行确认，只有在用户同意后才会继续执行操作。

2.  **安全护栏机制**：系统在处理用户输入前，会通过专门的AI代理进行安全检查，包括越狱防护（Jailbreak Guardrail）和相关性检查（Relevance Guardrail）。
    *   **越狱防护**：检测用户是否试图绕过系统指令或进行越狱攻击（如询问系统提示词、注入恶意代码等）。如果检测到越狱行为，系统将拒绝响应并提示用户。
    *   **相关性检查**：检测用户的最新消息是否与客服系统的业务范围（航班、租车、酒店、电商、表单、博客等）高度相关。对于不相关的输入，系统会记录日志或发出警告（根据具体策略处理）。

3.  **人工审核机制 (GoHumanLoop)**：对于所有标记为“敏感工具”的操作，在用户确认后，系统还会通过 GoHumanLoop 框架将操作请求发送给系统管理员进行最终审核。管理员可以通过飞书等平台接收审核通知，并决定是否批准该操作。只有在管理员批准后，操作才会真正执行，进一步提升了系统的安全性。

## 6. 可观察性

项目集成了 LangSmith 以提供增强的可观察性，帮助跟踪请求的生命周期、工具使用情况、代理响应和错误，方便开发者监控和调试系统性能。
